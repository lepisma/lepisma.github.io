<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2022-09-18 Sun 18:36 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tangle Templates</title>
<meta name="author" content="Abhinav Tushar" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
</style>
<link rel="stylesheet" type="text/css" href="/assets/css/pace.css" />
<link rel="stylesheet" type="text/css" href="/assets/css/main.css" />
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.8.3/katex.min.css" />
<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,300,800" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Mono" >
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="/assets/js/pace.min.js"></script>
<script src="/assets/js/jquery.zoomooz.min.js"></script>
<link rel="apple-touch-icon-precomposed" sizes="57x57" href="/assets/favicons/apple-touch-icon-57x57.png" />
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/assets/favicons/apple-touch-icon-114x114.png" />
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/assets/favicons/apple-touch-icon-72x72.png" />
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/favicons/apple-touch-icon-144x144.png" />
<link rel="apple-touch-icon-precomposed" sizes="60x60" href="/assets/favicons/apple-touch-icon-60x60.png" />
<link rel="apple-touch-icon-precomposed" sizes="120x120" href="/assets/favicons/apple-touch-icon-120x120.png" />
<link rel="apple-touch-icon-precomposed" sizes="76x76" href="/assets/favicons/apple-touch-icon-76x76.png" />
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="/assets/favicons/apple-touch-icon-152x152.png" />
<link rel="icon" type="image/png" href="/assets/favicons/favicon-196x196.png" sizes="196x196" />
<link rel="icon" type="image/png" href="/assets/favicons/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/png" href="/assets/favicons/favicon-32x32.png" sizes="32x32" />
<link rel="icon" type="image/png" href="/assets/favicons/favicon-16x16.png" sizes="16x16" />
<link rel="icon" type="image/png" href="/assets/favicons/favicon-128.png" sizes="128x128" />
<meta name="application-name" content="&nbsp;" />
<meta name="msapplication-TileColor" content="#FFFFFF" />
<meta name="msapplication-TileImage" content="/assets/favicons/mstile-144x144.png" />
<meta name="msapplication-square70x70logo" content="/assets/favicons/mstile-70x70.png" />
<meta name="msapplication-square150x150logo" content="/assets/favicons/mstile-150x150.png" />
<meta name="msapplication-wide310x150logo" content="/assets/favicons/mstile-310x150.png" />
<meta name="msapplication-square310x310logo" content="/assets/favicons/mstile-310x310.png" />
<script defer data-domain="lepisma.xyz" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
<div id="preamble" class="status">
<header>
  <div class='site-title'>
    <a href='/'>
      <img src='/assets/images/avatar32.png'>
    </a>
  </div>
  <div class='site-nav'>
    <a class='active' href='/'> blog</a>
    <a  href='/journal'> journal</a>
    <a  href='/log'> log</a>
    <a  href='/wiki'> wiki</a>
    <a href='/about'> about</a>
  </div>
  <div class='clearfix'></div>
</header>

<div class='page-header'>
  <div class='page-meta'>2018-08-26 Sun 00:00</div>
  <h1>Tangle Templates</h1>
</div>
</div>
<div id="content" class="content">
<div class='page-tags'><a href='../../..#org-mode'>org-mode</a> <a href='../../..#programming'>programming</a> <a href='../../..#emacs'>emacs</a> <a href='../../..#tooling'>tooling</a></div>
<p>
<span class='dropcap'>L</span>ooking recently at <a href="https://github.com/commercialhaskell/stack-templates/blob/master/simple.hsfiles">hsfiles</a> template made me fiddle around with a relatively old
script for <i>project template management</i> using <code>org-babel</code>. If you have used any
scaffolding tool like <a href="https://github.com/audreyr/cookiecutter">cookiecutter</a>, you already know what I mean by template
management for <i>projects</i>.
</p>

<p>
I tried using cookiecutter long ago but then stopped. Not sure of the exact
reason but here are few points that cover parts of the dissatisfaction (in
context of the new scheme from this post):
</p>

<ol class="org-ol">
<li><b>UPDATION</b>: Keeping <i>template-ish</i> content spread around in a directory makes
them cumbersome to update.</li>
<li><b>UNIFICATION</b>: Different languages have different scaffolding tools, like
<a href="https://www.xach.com/lisp/quickproject/">quickproject</a> for Lisp, <a href="http://poetry.eustace.io/">poetry</a>'s for python etc. There should be a simple way
to wrap them around.</li>
<li><b>REUSABILITY</b>: Once we have the above <i>wrapping around</i>, there should be a way
for extending templates with reusable components. For example, I might want
to add my common testing structure to poetry's <code>init</code> process <i>and</i> a conda based
project.</li>
<li><b>FLEXIBILITY</b>: Pre-execution editing of the templates makes them very practical
since I might want to change something which was not planned as a template
variable. Almost all other scaffolding tools are horrifically bad in this
situation because of their terminal centered approach.</li>
</ol>

<div id="outline-container-sec-obtt" class="outline-2">
<h2 id="sec-obtt"><span class="section-number-2">1.</span> obtt</h2>
<div class="outline-text-2" id="text-sec-obtt">


<p>
obtt (<i>Org Babel Tangle Templates</i>) is a little tool which extends the idea of
<code>hsfiles</code> templates and solves a lot of the issues I have with tools like
cookiecutter. Here is how its supposed to be used:
</p>

<ol class="org-ol">
<li>Describe project templates in org files using <a href="https://github.com/joaotavora/yasnippet">yasnippet</a> like templates and
org babel tangle blocks.</li>
<li>Fire <code>obtt-new</code> to select the root project directory and select the template to
use.</li>
<li>The next buffer (seed buffer) will drop you in yasnippet expansion state.
Edit all you want and then fire <code>obtt-tangle</code> to finish.</li>
</ol>

<p>
Using org mode lets you do other useful things like evaluating a code block.
This can be useful in cases where you want to generate content of a file from an
external tool. For example if you use <a href="https://github.com/generate/generate-license">generate-license</a> for licenses, you can add
the following block with <code>:obtt eval</code> in the header.
</p>

<pre class="example" id="org1aa87e3">
#+BEGIN_SRC shell :obtt eval
gen license:gpl-3.0
#+END_SRC
</pre>

<p>
There are other obvious benefits like including another template using the
<code>#+INCLUDE: sub-template.obtt</code>. You might also <i>template</i> the parameter out to
switch easily between, say, CI config files like below:
</p>

<div class="org-src-container">
<pre class="src src-org"><span class="org-org-meta-line">#+INCLUDE: ${1:gitlab-ci.obtt}</span>
</pre>
</div>

<p>
Having an org file as your template also lets you add useful documentation which
makes the whole workflow more shareable and easier to tweak without bringing in
inconsistencies.
</p>
</div>
</div>

<div id="outline-container-sec-a-sample-template" class="outline-2">
<h2 id="sec-a-sample-template"><span class="section-number-2">2.</span> A sample template</h2>
<div class="outline-text-2" id="text-sec-a-sample-template">


<p>
Here is a sample template from my config. As described in the preamble, its not
the one I use right now and things might change. Good for conveying a general
idea though.
</p>

<div class="org-src-container">
<pre class="src src-org"><span class="org-comment"># -*- mode: org -*-</span>
<span class="org-org-document-info-keyword">#+TITLE:</span> <span class="org-org-document-title">obtt-experiment</span>

This is a snakemake + poetry based template for experimental projects. Heavily
inspired by other <span class="org-italic">data science</span> templates. Most of the experiments use a conda
based setup but this template just uses poetry for now. I will tune this when
needed.

<span class="org-org-level-1"><span class="org-org-superstar-header-bullet">*</span></span><span class="org-org-level-1"> Variables</span>

<span class="org-org-list-dt"><span class="org-org-variable-pitch-fixed">-</span></span><span class="org-org-indent"><span class="org-org-variable-pitch-fixed"> </span></span><span class="org-org-list-dt">Name ::</span> $1
<span class="org-org-list-dt"><span class="org-org-variable-pitch-fixed">-</span></span><span class="org-org-indent"><span class="org-org-variable-pitch-fixed"> </span></span><span class="org-org-list-dt">Description ::</span> $2

<span class="org-org-level-1"><span class="org-org-superstar-header-bullet">*</span></span><span class="org-org-level-1"> README</span>

<span class="org-org-block-begin-line">#+BEGIN_SRC org :tangle ./README.org</span>
<span class="org-org-block"><span class="org-org-document-info-keyword">#+TITLE:</span></span><span class="org-org-block"> </span><span class="org-org-block"><span class="org-org-document-title">$1</span></span>

<span class="org-org-block">$2</span>
<span class="org-org-block-end-line">#+END_SRC</span>

<span class="org-org-level-1"><span class="org-org-superstar-header-bullet">*</span></span><span class="org-org-level-1"> toml file</span>

<span class="org-org-block-begin-line">#+BEGIN_SRC toml :tangle ./pyproject.toml</span>
<span class="org-org-block">[</span><span class="org-org-block"><span class="org-type">tool.poetry</span></span><span class="org-org-block">]</span>
<span class="org-org-block"><span class="org-variable-name">name</span></span><span class="org-org-block"> = </span><span class="org-org-block"><span class="org-string">"$1"</span></span>
<span class="org-org-block"><span class="org-variable-name">version</span></span><span class="org-org-block"> = </span><span class="org-org-block"><span class="org-string">"0.1.0"</span></span>
<span class="org-org-block"><span class="org-variable-name">description</span></span><span class="org-org-block"> = </span><span class="org-org-block"><span class="org-string">"$2"</span></span>
<span class="org-org-block"><span class="org-variable-name">authors</span></span><span class="org-org-block"> = []</span>

<span class="org-org-block">[</span><span class="org-org-block"><span class="org-type">tool.poetry.dependencies</span></span><span class="org-org-block">]</span>
<span class="org-org-block"><span class="org-variable-name">python</span></span><span class="org-org-block"> = </span><span class="org-org-block"><span class="org-string">"^3.6"</span></span>
<span class="org-org-block"><span class="org-variable-name">snakemake</span></span><span class="org-org-block"> = </span><span class="org-org-block"><span class="org-string">"^5.2"</span></span>

<span class="org-org-block">[</span><span class="org-org-block"><span class="org-type">tool.poetry.dev-dependencies</span></span><span class="org-org-block">]</span>
<span class="org-org-block"><span class="org-variable-name">pytest</span></span><span class="org-org-block"> = </span><span class="org-org-block"><span class="org-string">"^3.0"</span></span>
<span class="org-org-block"><span class="org-variable-name">mypy</span></span><span class="org-org-block"> = </span><span class="org-org-block"><span class="org-string">"^0.620.0"</span></span>
<span class="org-org-block-end-line">#+END_SRC</span>

<span class="org-org-level-1"><span class="org-org-superstar-header-bullet">*</span></span><span class="org-org-level-1"> General structure</span>

We have a <span class="org-org-code">data</span> directory with external and processed sub dirs. A <span class="org-org-code">src</span> directory
keeps the modules that we build and use. <span class="org-org-code">scripts</span> keep snakemake scripts.

<span class="org-org-block-begin-line">#+BEGIN_SRC shell :obtt eval</span>
<span class="org-org-block">mkdir -p data/external data/processed</span>
<span class="org-org-block">mkdir scripts</span>
<span class="org-org-block">mkdir src</span>
<span class="org-org-block">touch ./src/__init__.py</span>
<span class="org-org-block-end-line">#+END_SRC</span>

The snakefile rules now bind everything together.

<span class="org-org-block-begin-line">#+BEGIN_SRC python :tangle ./Snakefile</span>
<span class="org-org-block">rule </span><span class="org-org-block"><span class="org-builtin">all</span></span><span class="org-org-block">:</span>
<span class="org-org-block">    shell: </span><span class="org-org-block"><span class="org-string">"echo 'hi'"</span></span>
<span class="org-org-block-end-line">#+END_SRC</span>

<span class="org-org-level-1"><span class="org-org-superstar-header-bullet">*</span></span><span class="org-org-level-1"> Testing</span>

Tests are important even in experimental code, blah blah...

<span class="org-org-block-begin-line">#+BEGIN_SRC python :tangle ./tests/__init__.py</span>
<span class="org-org-block-end-line">#+END_SRC</span>

<span class="org-org-block-begin-line">#+BEGIN_SRC python :tangle ./mypy.ini</span>
<span class="org-org-block"><span class="org-rainbow-delimiters-depth-1">[</span></span><span class="org-org-block">mypy</span><span class="org-org-block"><span class="org-rainbow-delimiters-depth-1">]</span></span>
<span class="org-org-block"><span class="org-variable-name">ignore_missing_imports</span></span><span class="org-org-block">=</span><span class="org-org-block"><span class="org-constant">True</span></span>
<span class="org-org-block-end-line">#+END_SRC</span>

<span class="org-org-block-begin-line">#+BEGIN_SRC text :tangle ./tox.ini</span>
<span class="org-org-block">[tox]</span>
<span class="org-org-block">skipsdist = True</span>
<span class="org-org-block">envlist = py36</span>

<span class="org-org-block">[testenv]</span>
<span class="org-org-block">whitelist_externals = poetry</span>
<span class="org-org-block">skip_install = true</span>
<span class="org-org-block">commands =</span>
<span class="org-org-block">    poetry install -v</span>
<span class="org-org-block">    poetry run pytest tests/</span>
<span class="org-org-block-end-line">#+END_SRC</span>

<span class="org-org-level-1"><span class="org-org-superstar-header-bullet">*</span></span><span class="org-org-level-1"> License</span>

<span class="org-org-block-begin-line">#+BEGIN_SRC shell :obtt eval</span>
<span class="org-org-block">gen license:gpl-3.0</span>
<span class="org-org-block-end-line">#+END_SRC</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-the-package" class="outline-2">
<h2 id="sec-the-package"><span class="section-number-2">3.</span> The package</h2>
<div class="outline-text-2" id="text-sec-the-package">


<p>
The obtt package is in <a href="https://github.com/lepisma/rogue/blob/4a8a26f83d859db57b7b93467eab99ba2a1a2d29/local/obtt/obtt.el">my config</a> as of now. I will be moving it out after a
while. Other obtt templates are <a href="https://github.com/lepisma/rogue/tree/master/obtt">here</a> right now. One issue with this scheme is
that conflicts can popup among yasnippet variables when you include other
templates. But it should be easy to resolve by allowing users to name variables
and then recreating the numbered variables, <code>$1</code>, <code>$2</code> etc that yasnippet expects.
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<footer id='footer'></footer>
</div>
</body>
</html>
