<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2025-01-30 Thu 12:55 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Semantic Search and On-Device ML in Emacs</title>
<meta name="author" content="Abhinav Tushar" />
<meta name="generator" content="Org Mode" />
<style type="text/css">
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" type="text/css" href="/assets/css/pace.css" />
<link rel="stylesheet" type="text/css" href="/assets/css/main.css" />
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.8.3/katex.min.css" />
<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,300,800" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Mono" >
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="/assets/js/pace.min.js"></script>
<script src="/assets/js/jquery.zoomooz.min.js"></script>
<link rel="apple-touch-icon-precomposed" sizes="57x57" href="/assets/favicons/apple-touch-icon-57x57.png" />
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/assets/favicons/apple-touch-icon-114x114.png" />
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/assets/favicons/apple-touch-icon-72x72.png" />
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/favicons/apple-touch-icon-144x144.png" />
<link rel="apple-touch-icon-precomposed" sizes="60x60" href="/assets/favicons/apple-touch-icon-60x60.png" />
<link rel="apple-touch-icon-precomposed" sizes="120x120" href="/assets/favicons/apple-touch-icon-120x120.png" />
<link rel="apple-touch-icon-precomposed" sizes="76x76" href="/assets/favicons/apple-touch-icon-76x76.png" />
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="/assets/favicons/apple-touch-icon-152x152.png" />
<link rel="icon" type="image/png" href="/assets/favicons/favicon-196x196.png" sizes="196x196" />
<link rel="icon" type="image/png" href="/assets/favicons/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/png" href="/assets/favicons/favicon-32x32.png" sizes="32x32" />
<link rel="icon" type="image/png" href="/assets/favicons/favicon-16x16.png" sizes="16x16" />
<link rel="icon" type="image/png" href="/assets/favicons/favicon-128.png" sizes="128x128" />
<meta name="application-name" content="&nbsp;" />
<meta name="msapplication-TileColor" content="#FFFFFF" />
<meta name="msapplication-TileImage" content="/assets/favicons/mstile-144x144.png" />
<meta name="msapplication-square70x70logo" content="/assets/favicons/mstile-70x70.png" />
<meta name="msapplication-square150x150logo" content="/assets/favicons/mstile-150x150.png" />
<meta name="msapplication-wide310x150logo" content="/assets/favicons/mstile-310x150.png" />
<meta name="msapplication-square310x310logo" content="/assets/favicons/mstile-310x310.png" />
<script defer data-domain="lepisma.xyz" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
<div id="preamble" class="status">
<header>
  <div class='site-title'>
    <a href='/'>
      <img src='/assets/images/avatar32.png'>
    </a>
  </div>
  <div class='site-nav'>
    <a class='active' href='/'> blog</a>
    <a  href='/journal'> journal</a>
    <a  href='/log'> <s>log</s></a>
    <a  href='/wiki'> wiki</a>
    <a href='/about'> about</a>
    <a href='/wiki/support.html' class='btn small primary'>$ support </a>
  </div>
  <div class='clearfix'></div>
</header>

<div class='page-header'>
  <div class='page-meta'>2025-01-17 Fri 00:00</div>
  <h1>Semantic Search and <i>On-Device ML</i> in Emacs</h1>
</div>
</div>
<div id="content" class="content">
<div class='page-tags'><a href='../../../..#emacs'>emacs</a> <a href='../../../..#ml'>ml</a></div>
<p>
<span class='dropcap'>I</span>n the last EmacsConf, I had <a href="https://emacsconf.org/2024/talks/links/">a talk</a> in which I was running a few semantic
queries in Emacs via <a href="https://github.com/lepisma/org-roam-exts/tree/a71f2ec3bb6bd9d2b21ab5fd70ec45fa18128896/org-roam-sem">an external Python server</a>. Someone pointed that the
usability of this system is going to be low if I have to run a separate process
for ML tasks. That pushed me to make <a href="https://github.com/lepisma/onnx.el">ONNX.el</a> for running models in ONNX
format. I then built <a href="https://github.com/lepisma/tokenizers.el">tokenizers.el</a> to convert text to tokens. Finally I wrapped
everything together in <a href="https://github.com/lepisma/sem.el/">sem.el</a> which provides high level semantic search
functions that run inside Emacs as dynamic modules without needing any external
process or API.
</p>

<p>
By default <code>sem</code> runs a local <a href="https://huggingface.co/sentence-transformers/all-MiniLM-L6-v2">all-MiniLM-L6-v2</a> model for text embeddings. This
model is small and runs fast on CPU. Additionally, we load an <a href="https://huggingface.co/docs/optimum/v1.6.4/onnxruntime/usage_guides/optimization">O2 optimized
variant</a> which helps further. The vectors are stored in a <a href="https://github.com/lancedb/lancedb">lancedb</a> database on
file system which runs without a separate process. I was originally writing the
vector db core myself to learn more of Rust, but then stopped doing that since
lancedb gives all that I needed, out of the box.
</p>

<p>
To test that everything works reasonably, I tried making a semantic search
version of <code>apropos-documentation</code> command in Emacs. This
<code>apropos-documentation-sem</code> is simpler in that it does semantic search only on
function (not variable) documentations from symbols in <i>obarray</i>. To do this,
firstly we need to set up a store for vectors and push all the symbols with
documentation there:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">require</span> '<span class="org-constant">apropos</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">require</span> '<span class="org-constant">sem</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">require</span> '<span class="org-constant">sem-embed</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defvar</span> <span class="org-variable-name">apropos-sem-documentation-store</span> <span class="org-string">"apropos"</span>
  <span class="org-doc">"Name of the database for storing documentation."</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span>sem-store-new apropos-sem-documentation-store sem-embed-dim<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">setq</span> store <span class="org-rainbow-delimiters-depth-2">(</span>sem-store-load apropos-sem-documentation-store<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">let</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">(</span>batch-size 50<span class="org-rainbow-delimiters-depth-3">)</span>
      <span class="org-rainbow-delimiters-depth-3">(</span>batch<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>mapatoms <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">lambda</span> <span class="org-rainbow-delimiters-depth-4">(</span>symbol<span class="org-rainbow-delimiters-depth-4">)</span>
              <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-keyword">when-let</span> <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-rainbow-delimiters-depth-6">(</span>doc <span class="org-rainbow-delimiters-depth-7">(</span>apropos-safe-documentation symbol<span class="org-rainbow-delimiters-depth-7">)</span><span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span>
                <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-keyword">push</span> <span class="org-rainbow-delimiters-depth-6">(</span>cons symbol doc<span class="org-rainbow-delimiters-depth-6">)</span> batch<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span>
              <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-keyword">when</span> <span class="org-rainbow-delimiters-depth-5">(</span>= batch-size <span class="org-rainbow-delimiters-depth-6">(</span>length batch<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span>
                <span class="org-rainbow-delimiters-depth-5">(</span>sem-add-batch store batch #'sem-embed-default<span class="org-rainbow-delimiters-depth-5">)</span>
                <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-keyword">setq</span> batch nil<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">Store unaligned leftovers</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">when</span> batch <span class="org-rainbow-delimiters-depth-3">(</span>sem-add-batch store batch #'sem-embed-default<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
This takes a bit of time (~ 20 mins on my machine: <code>HP Spectre X360 11th Gen
Intel Evo Core i5</code>). There is some extra vector copying involved here right now
which will go away in later versions.
</p>

<p>
Searching over these vectors (running <code>#'sem-items-count</code> gives me 38,171) is
pretty fast though.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">benchmark-sem</span> <span class="org-rainbow-delimiters-depth-2">()</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">let</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">(</span>n-runs 10<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>format <span class="org-string">"%f seconds / query"</span>
            <span class="org-rainbow-delimiters-depth-4">(</span>/ <span class="org-rainbow-delimiters-depth-5">(</span>car <span class="org-rainbow-delimiters-depth-6">(</span><span class="org-keyword">benchmark-run</span> n-runs
                      <span class="org-rainbow-delimiters-depth-7">(</span>sem-similar store <span class="org-string">"testing"</span> 5 <span class="org-rainbow-delimiters-depth-8">(</span><span class="org-keyword">lambda</span> <span class="org-rainbow-delimiters-depth-9">(</span>it<span class="org-rainbow-delimiters-depth-9">)</span> <span class="org-rainbow-delimiters-depth-9">(</span>aref <span class="org-rainbow-delimiters-depth-1">(</span>sem-embed-default <span class="org-rainbow-delimiters-depth-2">(</span>list <span class="org-rainbow-delimiters-depth-3">(</span>prin1-to-string it<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span> 0<span class="org-rainbow-delimiters-depth-9">)</span><span class="org-rainbow-delimiters-depth-8">)</span><span class="org-rainbow-delimiters-depth-7">)</span><span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span>
               n-runs<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span>benchmark-sem<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example">
0.089578 seconds / query
</pre>


<p>
You can always build an index (<a href="https://lancedb.github.io/lancedb/concepts/index_ivfpq/">IVF-PQ index</a> by default) over the vectors to
speed this up even further at the cost of some accuracy.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span>sem-build-index store<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span>benchmark-sem<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<pre class="example">
0.032963 seconds / query
</pre>


<p>
Now we can run searches and produce output like any other apropos command:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defun</span> <span class="org-function-name">apropos-documentation-sem</span> <span class="org-rainbow-delimiters-depth-2">(</span>search-phrase <span class="org-type">&amp;optional</span> k<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-doc">"Search function docstrings (and name) using semantic search on SEARCH-PHRASE.</span>

<span class="org-doc">Return top K results."</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">interactive</span> <span class="org-string">"sSearch phrase: "</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">let*</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">(</span>results <span class="org-rainbow-delimiters-depth-5">(</span>sem-similar store search-phrase <span class="org-rainbow-delimiters-depth-6">(</span><span class="org-keyword">or</span> k 10<span class="org-rainbow-delimiters-depth-6">)</span> <span class="org-rainbow-delimiters-depth-6">(</span><span class="org-keyword">lambda</span> <span class="org-rainbow-delimiters-depth-7">(</span>it<span class="org-rainbow-delimiters-depth-7">)</span> <span class="org-rainbow-delimiters-depth-7">(</span>aref <span class="org-rainbow-delimiters-depth-8">(</span>sem-embed-default <span class="org-rainbow-delimiters-depth-9">(</span>list <span class="org-rainbow-delimiters-depth-1">(</span>prin1-to-string it<span class="org-rainbow-delimiters-depth-1">)</span><span class="org-rainbow-delimiters-depth-9">)</span><span class="org-rainbow-delimiters-depth-8">)</span> 0<span class="org-rainbow-delimiters-depth-7">)</span><span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span>
         <span class="org-rainbow-delimiters-depth-4">(</span>apropos-accumulator <span class="org-rainbow-delimiters-depth-5">(</span>mapcar <span class="org-rainbow-delimiters-depth-6">(</span><span class="org-keyword">lambda</span> <span class="org-rainbow-delimiters-depth-7">(</span>res<span class="org-rainbow-delimiters-depth-7">)</span> <span class="org-rainbow-delimiters-depth-7">(</span>list <span class="org-rainbow-delimiters-depth-8">(</span>cadr res<span class="org-rainbow-delimiters-depth-8">)</span> <span class="org-rainbow-delimiters-depth-8">(</span>car res<span class="org-rainbow-delimiters-depth-8">)</span> <span class="org-rainbow-delimiters-depth-8">(</span>cddr res<span class="org-rainbow-delimiters-depth-8">)</span> nil<span class="org-rainbow-delimiters-depth-7">)</span><span class="org-rainbow-delimiters-depth-6">)</span> results<span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>apropos-print nil <span class="org-string">"\n----------------\n"</span> <span class="org-rainbow-delimiters-depth-4">(</span>format <span class="org-string">"Semantic search results for: %s"</span> search-phrase<span class="org-rainbow-delimiters-depth-4">)</span> t<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>


<figure id="org21f5ac7">
<img src="screen.png" alt="screen.png" class="zoomTarget" data-closeclick="true">

<figcaption><span class="figure-number">Figure 1: </span>Results for "hex to rgb" in apropos output buffer</figcaption>
</figure>

<hr>

<p>
While searching over symbol documentation is a good test&#x2014;since Emacs obarray
is a realistic workload with a healthy amount of items&#x2014;I do not think semantic
search is helpful here. Most of my documentation searches have been better
served with regular full string search since I already know the starting point
which could be another function name, a module, etc. providing me with partial
words.
</p>

<p>
My primary motivation is to put semantic search to use in my note taking system
and that will drive any further development here. In any case, what follows is
the setup code and config if you also want to do semantic searches within Emacs.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;; </span><span class="org-comment">This needs cargo installed</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">use-package</span> tokenizers
  <span class="org-builtin">:vc</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-builtin">:fetcher</span> github <span class="org-builtin">:repo</span> lepisma/tokenizers.el<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-builtin">:demand</span> t<span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">This needs onnnxruntime development library installed on your system</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">use-package</span> onnx
  <span class="org-builtin">:vc</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-builtin">:fetcher</span> github <span class="org-builtin">:repo</span> lepisma/onnx.el<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-builtin">:demand</span> t<span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">use-package</span> sem
  <span class="org-builtin">:vc</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-builtin">:fetcher</span> github <span class="org-builtin">:repo</span> lepisma/sem.el<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-builtin">:demand</span> t
  <span class="org-builtin">:config</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">Create database directory</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">setq</span> sem-database-dir <span class="org-rainbow-delimiters-depth-3">(</span>expand-file-name <span class="org-rainbow-delimiters-depth-4">(</span>concat user-emacs-directory <span class="org-string">"sem/"</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>make-directory sem-database-dir t<span class="org-rainbow-delimiters-depth-2">)</span>

  <span class="org-comment-delimiter">;; </span><span class="org-comment">Setup default text embedding model</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">setq</span> sem-embed-model-path <span class="org-rainbow-delimiters-depth-3">(</span>concat sem-database-dir <span class="org-string">"model_O2.onnx"</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">unless</span> <span class="org-rainbow-delimiters-depth-3">(</span>file-exists-p sem-embed-model-path<span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>message <span class="org-string">"Model missing for sem-embed, downloading..."</span><span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>url-copy-file <span class="org-string">"https://huggingface.co/sentence-transformers/all-MiniLM-L6-v2/resolve/main/onnx/model_O2.onnx?download=true"</span> sem-embed-model-path<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
The installation takes care of compilation as a blocking call which might be
slow, specially for <code>sem</code>. There are also a few rough edges around some database
operations which I will fix as needed.
</p>

<p>
With <a href="https://github.com/lepisma/onnx.el">ONNX.el</a> you can run any ML model inside Emacs, including ones for images,
audios, etc. In case you are running embedding models, combine this with <a href="https://github.com/lepisma/sem.el">sem.el</a>
to perform semantic searches. Depending on your input modality, you might have
to figure out preprocessing.  For text, <a href="https://github.com/lepisma/tokenizers.el">tokenizers.el</a> should cover all of what
you need in modern NLP for preprocessing, though you will have to do something
on your own for anything non-text or multimodal.
</p>
</div>
<div id="postamble" class="status">
<footer id='footer'></footer>
</div>
</body>
</html>
